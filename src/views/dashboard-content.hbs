<!-- Welcome Header -->
<div class="mb-8">
    <h1 class="text-3xl font-bold text-[#5C4633]">Satori SPA te da la Bienvenida {{#if user_name}}{{user_name}}{{else}}Administrador{{/if}}</h1>
    <p class="text-[#8C837B]">Aquí tienes un resumen de la actividad de tu spa.</p>
</div>

<div class="grid grid-cols-4 gap-6 mb-14 ml-32">
    <div class="bg-white rounded-xl shadow p-6 border border-[#EAE3D9] flex flex-col items-center">
        <div class="text-[#8C837B] mb-2"><i class="fa-regular fa-circle-user"></i> Total de Usuarios</div>
        <div id="totalUsuarios" class="text-3xl font-bold text-[#5C4633]">{{totalUsuarios}}</div>
        <div class="text-xs text-[#8C837B] mt-2">+12% desde el mes pasado</div>
    </div>
    <div class="bg-white rounded-xl shadow p-6 border border-[#EAE3D9] flex flex-col items-center">
        <div class="text-[#8C837B] mb-2"><i class="fa-solid fa-list mr-2"></i>Total de Servicios</div>
        <div id="serviciosActivos" class="text-3xl font-bold text-[#5C4633]">{{totalServicios}}</div>
        <div class="text-xs text-[#8C837B] mt-2">+2 nuevos servicios</div>
    </div>
    <div class="bg-white rounded-xl shadow p-6 border border-[#EAE3D9] flex flex-col items-center">
        <div class="text-[#8C837B] mb-2"><i class="fa-regular fa-calendar-days mr-2"></i>Total de Citas</div>
        <div id="citasHoy" class="text-3xl font-bold text-[#5C4633]">{{totalCitas}}</div>
    </div>
</div>

<!-- Appointments Section -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Appointment Stats Chart -->
    <div class="bg-white p-6 rounded-2xl shadow-lg flex flex-col">
        <h2 class="font-bold text-xl text-[#5C4633] mb-4">Rendimiento Semanal de Citas</h2>
        <div class="relative h-64">
            <canvas id="citasChart"></canvas>
        </div>
    </div>

    <!-- Appointments of the Day Card -->
    <div class="bg-white p-6 rounded-2xl shadow-lg flex flex-col">
        <h2 class="font-bold text-xl text-[#5C4633] mb-4">Citas del Día</h2>
        <div class="overflow-y-auto h-64">
            <table class="min-w-full bg-white">
                <thead class="bg-[#F9F5F0] sticky top-0">
                    <tr>
                        <th class="py-2 px-4 text-left text-xs font-medium text-[#5C4633] uppercase tracking-wider">Cliente</th>
                        <th class="py-2 px-4 text-left text-xs font-medium text-[#5C4633] uppercase tracking-wider">Servicio</th>
                        <th class="py-2 px-4 text-left text-xs font-medium text-[#5C4633] uppercase tracking-wider">Hora</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-[#EAE3D9]">
                    {{#each citasDelDia}}
                    <tr>
                        <td class="py-3 px-4 whitespace-nowrap text-sm text-[#5C4633]">{{this.cliente}}</td>
                        <td class="py-3 px-4 whitespace-nowrap text-sm text-[#8C837B]">{{this.servicio}}</td>
                        <td class="py-3 px-4 whitespace-nowrap text-sm text-[#8C837B]">{{this.hora}}</td>
                    </tr>
                    {{else}}
                    <tr>
                        <td colspan="3" class="text-center py-4">No hay citas para hoy.</td>
                    </tr>
                    {{/each}}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Canceled Appointments Card -->
    <div class="bg-white p-6 rounded-2xl shadow-lg flex flex-col">
        <h2 class="font-bold text-xl text-[#5C4633] mb-4">Citas Canceladas</h2>
        <div class="overflow-y-auto h-64">
            <table class="min-w-full bg-white">
                <thead class="bg-[#F9F5F0] sticky top-0">
                    <tr>
                        <th class="py-2 px-4 text-left text-xs font-medium text-[#5C4633] uppercase tracking-wider">Cliente</th>
                        <th class="py-2 px-4 text-left text-xs font-medium text-[#5C4633] uppercase tracking-wider">Servicio</th>
                        <th class="py-2 px-4 text-left text-xs font-medium text-[#5C4633] uppercase tracking-wider">Fecha de la cita</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-[#EAE3D9]">
                    {{#each citasCanceladas}}
                    <tr>
                        <td class="py-3 px-4 whitespace-nowrap text-sm text-[#5C4633]">{{this.cliente}}</td>
                        <td class="py-3 px-4 whitespace-nowrap text-sm text-[#8C837B]">{{this.servicio}}</td>
                        <td class="py-3 px-4 whitespace-nowrap text-sm text-[#8C837B]">{{this.fechaCancelacion}}</td>
                    </tr>
                    {{else}}
                    <tr>
                        <td colspan="3" class="text-center py-4">No hay citas canceladas recientemente.</td>
                    </tr>
                    {{/each}}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('citasChart').getContext('2d');

        // Parsear los datos del gráfico proporcionados por el servidor.
        // La variable `chartData` es inyectada por el backend (ver `src/routes/index.js`).
        // Usamos `{{{chartData}}}` para que Handlebars no escape los caracteres JSON.
        const chartDataFromServer = JSON.parse('{{{chartData}}}');

        // Usar los datos del servidor. Si no hay datos, mostrar un estado vacío.
        const labels = chartDataFromServer.labels && chartDataFromServer.labels.length > 0 ? chartDataFromServer.labels : ['Sin Datos'];
        const dataValues = chartDataFromServer.data && chartDataFromServer.data.length > 0 ? chartDataFromServer.data : [0];

        const data = {
            labels: labels,
            datasets: [{
                label: 'Nº de Citas',
                data: dataValues,
                backgroundColor: 'rgba(92, 70, 51, 0.2)',
                borderColor: 'rgba(92, 70, 51, 1)',
                borderWidth: 2,
                borderRadius: 5,
                tension: 0.4
            }]
        };

        const config = {
            type: 'bar',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: '#EAE3D9'
                        },
                        ticks: {
                            color: '#8C837B',
                            stepSize: 1 // Mostrar números enteros en el eje Y
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#8C837B'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: '#5C4633',
                        titleColor: '#FFFFFF',
                        bodyColor: '#FFFFFF',
                        callbacks: {
                            label: function(context) {
                                return `Citas: ${context.raw}`;
                            }
                        }
                    }
                }
            }
        };

        new Chart(ctx, config);
    });
</script>